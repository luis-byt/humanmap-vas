<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Human Map VAS ‚Äî Demo</title>
  <link rel="icon" type="image/png" sizes="32x32" href="src/logo/favicon-32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="src/logo/favicon-64.png">
  <link rel="apple-touch-icon" sizes="180x180" href="src/logo/favicon-180.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563EB">
  <script src="humanmap-vas-standalone.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #f9fafb;
      color: #111827;
      margin: 0;
      padding: 1.5rem;
      display: flex;
      flex-direction: row;
      gap: 2rem;
      justify-content: center;
      align-items: flex-start;
    }
    /* Panel lateral */
    .sidebar {
      width: 280px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .sidebar h2 {
      font-size: 1rem;
      margin-top: 0;
      margin-bottom: 0.5rem;
      color: #1f2937;
    }
    .sidebar textarea {
      width: 95%;
      height: 390px;
      font-family: monospace;
      font-size: 13px;
      background: #1f2937;
      color: #d1d5db;
      line-height: 1.5;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 10px 12px;
      outline: none;
      resize: vertical;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }
    .sidebar button {
      margin-top: 0.5rem;
      width: 100%;
      padding: 8px;
      font-weight: 600;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .sidebar button:hover {
      background: #1d4ed8;
    }

    /* Contenedor principal (mapa + resultado) */
    .main {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      max-width: 700px;
      width: 100%;
    }

    human-map-vas {
      width: 100%;
      margin-bottom: 1rem;
    }

    pre {
      background: #1f2937;
      color: #f3f4f6;
      padding: 1rem;
      border-radius: 8px;
      width: 600px;
      max-width: 100%;
      overflow-x: auto;
      font-size: 13px;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
      text-align: center;
      width: 100%;
    }

    .footer {
      font-size: 13px;
      color: #6b7280;
      margin-top: 1rem;
    }
    /* ‚ú® Efecto de parpadeo al copiar */
    @keyframes flashCopy {
      0%   { background-color: rgba(16, 185, 129, 0.25); }
      100% { background-color: transparent; }
    }
    pre.copied {
      animation: flashCopy 0.2s ease-out;
    }
    .info-box {
      position: relative;
      background: #eef2f7;
      border-left: 4px solid #3b82f6;
      padding: 0.75rem 1rem;
      margin: 0.75rem 0 1.5rem 0;
      border-radius: 6px;
      color: #1f2937;
      font-size: 0.95rem;
      line-height: 1.4;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .info-box strong {
      display: block;
      margin-bottom: 0.3rem;
      color: #111827;
    }
    .info-box ul {
      margin: 0.4rem 0 0 1.2rem;
      padding: 0;
    }
    .info-box li {
      margin-bottom: 0.3rem;
    }
    .close-info {
      position: absolute;
      top: 6px;
      right: 10px;
      border: none;
      background: transparent;
      font-size: 1.1rem;
      font-weight: bold;
      color: #4b5563;
      cursor: pointer;
      line-height: 1;
      transition: color 0.2s ease;
    }
    .close-info:hover {
      color: #111827;
    }
    .countdown-text {
      margin-top: 0.6rem;
      font-size: 0.8rem;
      color: #6b7280;
      opacity: 0.8;
      text-align: right;
    }
    #helpButton {
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: #3b82f6;
      color: white;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: background 0.2s ease, transform 0.1s ease;
    }
    #helpButton:hover {
      background: #2563eb;
      transform: scale(1.05);
    }
    .sidebar-control {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
    }
    .sidebar-control label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      color: #111827;
    }
    .sidebar-control input[type="range"] {
      width: 100%;
      accent-color: #2563eb;
      cursor: pointer;
    }

  </style>
</head>
<body>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="main">
    <h1>ü©∫ Human Map VAS ‚Äî Demo Interactiva</h1>
    <p>Puedes navegar entre las vistas de Cabeza, Cuello y T√≥rax con los botones ‚óÄ ‚ñ∂ y limpiar selecci√≥n con üîÑ</p>

    <div class="info-box" id="infoBox">
      <button class="close-info" title="Cerrar">√ó</button>
      <strong>üí° Sobre las vistas y el modo de solo lectura:</strong>
      <ul>
        <li>El selector superior te permite cambiar entre las diferentes vistas anat√≥micas o mostrar <em>Todas</em> a la vez.</li>
        <li>Cuando activas el modo <strong>solo lectura</strong>, las zonas ya seleccionadas permanecen visibles pero no puedes interactuar con ellas.</li>
        <li>El modo de solo lectura es √∫til para <em>mostrar resultados guardados</em> sin riesgo de modificarlos accidentalmente.</li>
        <li>En modo global + solo lectura, la barra de herramientas se oculta y aparece un bot√≥n üñ®Ô∏è para imprimir o guardar la vista en PDF.</li>
      </ul>
      <div class="countdown-text" id="countdownText"></div>
    </div>

    <!-- Bot√≥n flotante para reabrir -->
    <button id="helpButton" title="Mostrar ayuda">‚ÑπÔ∏è</button>

    <!-- attrs:
          view="head_right(default) || head_left || neck_right || neck_left || etc.."
          img-root="/path/to/locale/images/"
          read-only="true || false (default)"
          columns="4"(default)
          style="--hm-height: 500px;" (default)
    -->
    <human-map-vas id="map"></human-map-vas>

    <h2>Zonas seleccionadas:</h2>
    <div class="output-wrapper" style="position: relative; width: 100%; max-width: 600px;">
      <pre id="output" style="
          background: #1f2937;
          color: #f3f4f6;
          padding: 1rem;
          border-radius: 8px;
          margin: 0;
          width: 100%;
          overflow-x: auto;
          font-size: 13px;
          font-family: monospace;
          white-space: pre-wrap;
          word-wrap: break-word;
        ">Ninguna zona seleccionada todav√≠a.</pre>

      <!-- Bot√≥n flotante üìã -->
      <button id="copyBtn"
        title="Copiar al portapapeles"
        style="
          position: absolute;
          top: 8px;
          right: 8px;
          background: rgba(55,65,81,0.85);
          color: #f9fafb;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 16px;
          padding: 4px 6px;
          line-height: 1;
          transition: background 0.2s ease;
        ">üìã</button>

      <!-- Aviso visual al copiar -->
      <span id="copyNotice"
        style="
          display: none;
          position: absolute;
          top: 8px;
          right: 38px;
          background: #10b981;
          color: #fff;
          padding: 2px 6px;
          border-radius: 4px;
          font-size: 11px;
          font-weight: 600;
          opacity: 0.95;
        ">Copiado</span>
    </div>

    <div class="footer">¬© Demo anat√≥mica ‚Äî Cabeza, Cuello y T√≥rax (Zonas de VAS+)</div>
  </div>

  <!-- PANEL LATERAL -->
  <div class="sidebar">
    <h2>‚öôÔ∏è Configuraci√≥n</h2>
    <p style="font-size:13px;color:#4b5563;">Carga una lista de zonas preseleccionadas:</p>
    <textarea id="zoneInput" placeholder="[]">
[
  {
    "id": "head_right-r1c1",
    "code": "1.1.2.1",
    "label": "1.1.2.1",
    "view": "head_right"
  },
  {
    "id": "head_right-r2c2",
    "code": "1.1.3.2",
    "label": "1.1.3.2",
    "view": "head_right"
  },
  {
    "id": "head_left-r1c3",
    "code": "1.2.2.1",
    "label": "1.2.2.1",
    "view": "head_left"
  }
]</textarea>
    <button id="loadZones">Cargar zonas</button>

    <hr style="margin:1rem 0; border:none; border-top:1px solid #e5e7eb;">
    <p style="font-size:13px;color:#4b5563;">Activar / Desactivar modo solo lectura:</p>
    <label style="display:flex; align-items:center; gap:6px; font-size:13px; cursor:pointer;">
      <input type="checkbox" id="toggleReadonly" style="accent-color:#2563eb;">
      Modo solo lectura
    </label>

    <hr style="margin:1rem 0; border:none; border-top:1px solid #e5e7eb;">

    <div id="columnsControl" class="sidebar-control" style="display:none;">
      <label for="columnsSlider">
        üß© Cantidad de columnas:
        <span id="columnsValue">4</span>
      </label>
      <input
        id="columnsSlider"
        type="range"
        min="2"
        max="4"
        step="1"
        value="4"
      />
    </div>


  </div>

  <!-- SCRIPT DE INTERACCI√ìN -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await customElements.whenDefined('human-map-vas');
      const map = document.querySelector('#map');
      const out = document.getElementById('output');
      const loadBtn = document.getElementById('loadZones');
      const input = document.getElementById('zoneInput');
      const readonlyToggle = document.getElementById('toggleReadonly');

      // Bot√≥n para cargar zonas escritas en el panel lateral
      loadBtn.addEventListener('click', () => {

        const text = zoneInput.value.trim();

        if (!text) {
          // No hay contenido: limpiar zonas o mostrar aviso
          map.selectedZones = [];
          console.warn('‚ö†Ô∏è El campo de zonas est√° vac√≠o. No se carg√≥ ning√∫n dato.');
        } else {
          try {
            const zones = JSON.parse(input.value);
            if (Array.isArray(zones)) {
              map.selectedZones = zones;
              out.textContent = JSON.stringify(map.selectedZones, null, 2);
            } else {
              alert('‚ö†Ô∏è El formato debe ser una lista de objetos JSON.');
            }
          } catch (err) {
            alert('‚ùå Error al parsear JSON:\n' + err.message);
          }
        }
      });

      loadBtn.click();

      // Mostrar en <pre> los cambios
      map.addEventListener('human-map-vas:select', e => {
        const selected = e.detail.selected;
        out.textContent = selected.length
          ? JSON.stringify(selected, null, 2)
          : 'Ninguna zona seleccionada todav√≠a.';
      });

      // Referencias del control
      const columnsControl = document.getElementById('columnsControl');
      const columnsSlider = document.getElementById('columnsSlider');
      const columnsValue = document.getElementById('columnsValue');

      // Actualizar el slider y valor visible
      columnsSlider.addEventListener('input', () => {
        const value = parseInt(columnsSlider.value, 10);
        columnsValue.textContent = value;
        map.setAttribute('columns', value);
        if (map.getAttribute('view') === 'all') {
          map._renderAllViews();
        }
      });

      // --- Mostrar u ocultar el control seg√∫n vista ---
      const updateColumnsVisibility = () => {
        if (map.getAttribute('view') === 'all') {
          columnsControl.style.display = 'flex';
        } else {
          columnsControl.style.display = 'none';
        }
      };

      // Al iniciar
      updateColumnsVisibility();

      // Escuchar cuando cambie la vista desde el componente
      map.addEventListener('human-map-vas:ready', updateColumnsVisibility);
      map.addEventListener('human-map-vas:select', updateColumnsVisibility);
      map.addEventListener('attributechange', updateColumnsVisibility);
      map.addEventListener('human-map-vas:view-changed', e => {
        const isGlobal = e.detail.view === 'all';
        columnsControl.style.display = isGlobal ? 'flex' : 'none';
      });


      // --- Copiar al portapapeles dentro del √°rea de resultados ---
      const copyBtn = document.getElementById('copyBtn');
      const copyNotice = document.getElementById('copyNotice');

      copyBtn.addEventListener('click', async () => {
        const text = out.textContent.trim();
        if (!text || text === 'Ninguna zona seleccionada todav√≠a.') return;

        try {
          await navigator.clipboard.writeText(text);

          // Mostrar el aviso temporal
          copyNotice.style.display = 'block';
          setTimeout(() => { copyNotice.style.display = 'none'; }, 1200);

          // ‚ú® Efecto de parpadeo en el <pre>
          out.classList.add('copied');
          setTimeout(() => out.classList.remove('copied'), 600);

        } catch (err) {
          console.error('Error copiando al portapapeles:', err);
        }
      });

      // sincroniza el checkbox al iniciar o al cambiar desde fuera
      map.addEventListener('human-map-vas:readonly-change', e => {
        readonlyToggle.checked = e.detail.readOnly;
      });

      // sincronizar al cargar si el atributo ya estaba presente
      readonlyToggle.checked = map.hasAttribute('read-only') && map.getAttribute('read-only') !== 'false';

      // Actualiza el estado de edici√≥n seg√∫n el modo de solo lectura
      function updateReadOnlyUI() {
        const isReadOnly = map.getAttribute('read-only') === 'true';

        // Desactivar o activar textarea y bot√≥n
        if (input) input.disabled = isReadOnly;
        if (loadBtn) loadBtn.disabled = isReadOnly;

        // Ajustar estilo visual (opcional)
        const opacity = isReadOnly ? 0.6 : 1;
        const cursor = isReadOnly ? 'not-allowed' : 'text';

        if (input) {
          input.style.opacity = opacity;
          input.style.cursor = cursor;
        }

        if (loadBtn) {
          loadBtn.style.opacity = opacity;
          loadBtn.style.cursor = isReadOnly ? 'not-allowed' : 'pointer';
        }
      }

      // escucha interacciones del usuario
      readonlyToggle.addEventListener('change', () => {
        if (readonlyToggle.checked) {
          map.setAttribute('read-only', 'true');
        } else {
          map.removeAttribute('read-only');
        }
        updateReadOnlyUI();
      });

      const INFO_KEY = 'humanmap_info_closed';
      const infoBox = document.getElementById('infoBox');
      const closeInfo = infoBox?.querySelector('.close-info');
      const countdownText = document.getElementById('countdownText');
      const helpButton = document.getElementById('helpButton');
      const AUTO_CLOSE_TIME = 10; // segundos iniciales

      let timer, countdownInterval;
      let remaining = AUTO_CLOSE_TIME;

      // Funci√≥n para cerrar con animaci√≥n y guardar estado
      const closeBox = () => {
        if (!infoBox) return;
        infoBox.style.opacity = '0';
        infoBox.style.transform = 'translateY(-10px)';
        setTimeout(() => {
          infoBox.remove();
          localStorage.setItem(INFO_KEY, 'true');
        }, 300);
      };

      // Funci√≥n para iniciar la cuenta regresiva
      const startCountdown = () => {
        remaining = AUTO_CLOSE_TIME;
        countdownText.textContent = `Este mensaje se autodestruir√° en ${remaining}s`;
        countdownInterval = setInterval(() => {
          remaining--;
          if (remaining > 0) {
            countdownText.textContent = `Este mensaje se autodestruir√° en ${remaining}s`;
          } else {
            clearInterval(countdownInterval);
            closeBox();
          }
        }, 1000);
      };

      // Mostrar u ocultar el bot√≥n de ayuda seg√∫n el estado
      const showHelpButton = (show) => {
        helpButton.style.display = show ? 'block' : 'none';
      };

      // Si ya se cerr√≥ el mensaje antes
      if (localStorage.getItem(INFO_KEY) === 'true') {
        if (infoBox) infoBox.remove();
        showHelpButton(true);
      } else {
        showHelpButton(false);
        startCountdown();
        // Cierre autom√°tico
        timer = setTimeout(closeBox, AUTO_CLOSE_TIME * 1000);
        infoBox.addEventListener('mouseenter', () => {
          clearTimeout(timer);
          clearInterval(countdownInterval);
        });
        infoBox.addEventListener('mouseleave', () => {
          timer = setTimeout(closeBox, 5000);
          remaining = 5;
          countdownText.textContent = `Este mensaje se autodestruir√° en ${remaining}s`;
          clearInterval(countdownInterval);
          countdownInterval = setInterval(() => {
            remaining--;
            if (remaining > 0) {
              countdownText.textContent = `Este mensaje se autodestruir√° en ${remaining}s`;
            } else {
              clearInterval(countdownInterval);
              closeBox();
            }
          }, 1000);
        });
      }

      // Cierre manual
      if (closeInfo) closeInfo.addEventListener('click', closeBox);

      // Reabrir el mensaje al hacer clic en el bot√≥n de ayuda
      helpButton.addEventListener('click', () => {
        localStorage.removeItem(INFO_KEY);
        location.reload(); // recarga la p√°gina para mostrar el mensaje otra vez
      });

    });
  </script>

  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      if (location.protocol === 'https:' || location.hostname === 'localhost') {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('‚úÖ Service Worker registrado:', reg.scope))
          .catch(err => console.error('‚ùå Error al registrar SW:', err));
      } else {
        console.warn('‚ö†Ô∏è Service Worker no disponible fuera de HTTPS o localhost.');
      }

    });
  }
  </script>

</body>
</html>
